<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>贪吃蛇</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { width: 100%; height: 100%; overflow: hidden; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
  background: #0b1020;
  color: #d9e4ff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  touch-action: none;
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}

#top {
  width: min(96vw, 420px);
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  margin-top: env(safe-area-inset-top, 0px);
}

#game {
  width: min(96vw, 420px);
  aspect-ratio: 1 / 1;
  border: 2px solid #3f84ff;
  border-radius: 10px;
  background: #050916;
}

#hint {
  width: min(96vw, 420px);
  font-size: 12px;
  opacity: 0.9;
  text-align: center;
}

#startBtn {
  width: min(96vw, 420px);
  height: 48px;
  border: 0;
  border-radius: 12px;
  background: #3f84ff;
  color: #fff;
  font-size: 16px;
  margin-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
}

#startBtn:disabled {
  opacity: 0.65;
}
</style>
</head>
<body>
  <div id="top">
    <span id="score">得分: 0</span>
    <span id="state">未开始</span>
  </div>

  <canvas id="game" width="400" height="400"></canvas>

  <p id="hint">滑动可四方向；点击按主方向判定：上/下半屏可向上/向下，左/右半屏可向左/向右</p>

  <button id="startBtn" type="button">开始游戏</button>

<script>
(function () {
  var body = document.body;
  var canvas = document.getElementById('game');
  var ctx = canvas.getContext('2d');
  var scoreEl = document.getElementById('score');
  var stateEl = document.getElementById('state');

  var cell = 20;
  var grid = canvas.width / cell;
  var snake = [];
  var food = { x: 0, y: 0 };
  var dirX = 1;
  var dirY = 0;
  var running = false;
  var timer = 0;
  var score = 0;
  var touchStartX = null;
  var touchStartY = null;

  function reset() {
    snake = [{ x: 8, y: 10 }];
    dirX = 1;
    dirY = 0;
    score = 0;
    placeFood();
    scoreEl.textContent = '得分: 0';
    draw();
  }

  function placeFood() {
    var ok = false;
    while (!ok) {
      food.x = Math.floor(Math.random() * grid);
      food.y = Math.floor(Math.random() * grid);
      ok = true;
      for (var i = 0; i < snake.length; i++) {
        if (snake[i].x === food.x && snake[i].y === food.y) {
          ok = false;
          break;
        }
      }
    }
  }

  function draw() {
    ctx.fillStyle = '#050916';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = '#3f84ff';
    for (var i = 0; i < snake.length; i++) {
      ctx.fillRect(snake[i].x * cell + 1, snake[i].y * cell + 1, cell - 2, cell - 2);
    }

    ctx.fillStyle = '#ff6b6b';
    ctx.fillRect(food.x * cell + 2, food.y * cell + 2, cell - 4, cell - 4);
  }

  function setLeft() {
    if (dirX !== 1) {
      dirX = -1;
      dirY = 0;
    }
  }

  function setRight() {
    if (dirX !== -1) {
      dirX = 1;
      dirY = 0;
    }
  }

  function setUp() {
    if (dirY !== 1) {
      dirX = 0;
      dirY = -1;
    }
  }

  function setDown() {
    if (dirY !== -1) {
      dirX = 0;
      dirY = 1;
    }
  }

  function onControlPoint(x, y) {
    if (!running) return;
    var midX = window.innerWidth / 2;
    var midY = window.innerHeight / 2;
    var dx = x - midX;
    var dy = y - midY;

    if (Math.abs(dy) >= Math.abs(dx)) {
      if (y < midY) setUp();
      else setDown();
      return;
    }

    if (x < midX) setLeft();
    else setRight();
  }

  function step() {
    if (!running) return;

    var head = snake[0];
    var next = { x: head.x + dirX, y: head.y + dirY };

    if (next.x < 0 || next.x >= grid || next.y < 0 || next.y >= grid) {
      end();
      return;
    }

    for (var i = 0; i < snake.length; i++) {
      if (snake[i].x === next.x && snake[i].y === next.y) {
        end();
        return;
      }
    }

    snake.unshift(next);

    if (next.x === food.x && next.y === food.y) {
      score += 10;
      scoreEl.textContent = '得分: ' + score;
      placeFood();
    } else {
      snake.pop();
    }

    draw();
    timer = setTimeout(step, 120);
  }

  function start() {
    if (running) return;
    if (timer) clearTimeout(timer);
    running = true;
    stateEl.textContent = '进行中';
    reset();
    step();
  }

  function end() {
    running = false;
    if (timer) clearTimeout(timer);
    stateEl.textContent = '已结束';

    ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'center';
    ctx.font = '24px sans-serif';
    ctx.fillText('游戏结束', canvas.width / 2, canvas.height / 2 - 8);
    ctx.font = '16px sans-serif';
    ctx.fillText('得分: ' + score, canvas.width / 2, canvas.height / 2 + 22);
  }

  body.addEventListener('touchstart', function (e) {
    e.preventDefault();
    if (!e.touches || !e.touches[0]) return;
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }, { passive: false });

  body.addEventListener('touchmove', function (e) {
    e.preventDefault();
  }, { passive: false });

  body.addEventListener('touchend', function (e) {
    e.preventDefault();

    if (!e.changedTouches || !e.changedTouches[0]) return;
    var endX = e.changedTouches[0].clientX;
    var endY = e.changedTouches[0].clientY;

    if (e.target && e.target.id === 'startBtn') {
      start();
      return;
    }

    if (touchStartX === null) {
      onControlPoint(endX, endY);
      return;
    }

    var dx = endX - touchStartX;
    var dy = endY - (touchStartY === null ? endY : touchStartY);
    touchStartX = null;
    touchStartY = null;

    if (Math.abs(dx) >= 18 || Math.abs(dy) >= 18) {
      if (Math.abs(dx) >= Math.abs(dy)) {
        if (dx > 0) setRight();
        else setLeft();
      } else {
        if (dy > 0) setDown();
        else setUp();
      }
      return;
    }

    onControlPoint(endX, endY);
  }, { passive: false });

  body.addEventListener('click', function (e) {
    e.preventDefault();

    if (e.target && e.target.id === 'startBtn') {
      start();
      return;
    }

    onControlPoint(e.clientX, e.clientY);
  }, { passive: false });

  document.addEventListener('keydown', function (e) {
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      setUp();
    } else if (e.key === 'ArrowDown') {
      e.preventDefault();
      setDown();
    } else if (e.key === 'ArrowLeft') {
      e.preventDefault();
      setLeft();
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      setRight();
    }
  });

  reset();
})();
</script>
</body>
</html>
